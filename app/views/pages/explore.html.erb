<% if user_signed_in? %>
  <div id="search-box">
    <div id="search-popular"></div>
    <div id="search-bar">
      <%= form_tag "#", method:"get" do %>
        <div>
          <%= text_field_tag :search, params[:search], class:"form-control search-box", id:"search-query", placeholder: "Search...", type:"text" %>
          <%= hidden_field_tag :search_value, id: "searchedValue" %>
        </div>
      <% end %>
    </div>
    <div id="search-total"></div>

  </div>

  <div id="search-result">
  </div>

  <div id="search-trend">
  </div>


<% else %>
<p> You must be signed in to view stories </p>
<% end %>

<script>

$(document).ready(function() {


  // Get trend information ?
  $.get('http://localhost:54321/api/trend', function(data, status) {
    $('#search-trend').append('<div id="exp-story-container">');
    data.hits.forEach(function(d) {
      var title = d._source.title || '';
      var content = d._source.content || '';
      var story_id = d._source.id || '';

      var story = '<div class="story"><h3>' + title + '</h3><p>';
      if(content.length > 250) {
        story += content.substring(0, 250) + '... <a class="read-more" href="/stories/' + story_id + '">Read more</a></p><a class="read-more" href="/stories/' + story_id + '">Add Comment</a>';
      } else {
        story += content + '</p><a class="read-more" href="/stories/' + story_id + '">Add Comment</a>';
      }
      story += '</div>';

      $('#exp-story-container').append(story);
    });
    $('#search-trend').append('</div>');
  });

  var popularTags = [];
  $('#search-popular').empty();
  $.get('http://localhost:54321/api/trend-tags', function(data, status) {
    data.buckets.forEach(function(b) {
      popularTags.push(b.key);
    });

    $('#search-popular').append('<strong>Trending tags: ' + popularTags.join(',&nbsp;') + '</strong>');
  });



  $('#search-query').on('keyup', function() {
    console.log('hello key pressed', $('#search-query').val());

    var q = $('#search-query').val();

    if (q.length < 3) {
      $('#search-result').empty();
      $('#search-total').empty();
      return;
    }

    $.get('http://localhost:54321/api/search?q='+q, function(data, status) {
      console.log(data);

      $('#search-result').empty();
      $('#search-trend').empty();
      $('#search-total').empty();

      if (data.total > 0) {
        $('#search-total').append('<br>Found <strong>' + data.total + '</strong> stories');
      }


      data.hits.forEach(function(d) {
        var title = d._source.title || '';
        var content = d._source.content || '';
        var story_id = d._source.id || '';

        var story = '<div class="story"><h3>' + title + '</h3><p>';
        if(content.length > 250) {
          story += content.substring(0, 250) + '... <a class="read-more" href="/stories/' + story_id + '">Read more</a></p><a class="read-more" href="/stories/' + story_id + '">Add Comment</a>';
        } else {
          story += content + '</p><a class="read-more" href="/stories/' + story_id + '">Add Comment</a>';
        }
        story += '</div>';

        $('#search-result').append(story);
      });

    });
  });

});

</script>
